#!/usr/bin/make -f
# -*- mode: makefile; coding: utf-8 -*-

top_dir := $(shell pwd)
prefix := usr
tmp_dir :=debian/tmp
pkg_build_dir := $(top_dir)/$(tmp_dir)
host = x86_64-unknown-linux-gnu
#--prefix=/$(prefix) 
build_opts = --without-gui --without-miniupnpc --disable-tests --prefix=$(top_dir)/depends/$(host) \
	--enable-hardening \
	CXXFLAGS='-fwrapv -fno-strict-aliasing -Werror -g' \
	--host=$(host) --build=$(host)

# configuration option for zcashd-node flavor
node_opts = $(build_opts) --disable-wallet
# configuration option for zcashd-wallet flavor
wallet_opts = $(build_opts) --enable-wallet

%:
	dh $@

override_dh_auto_build:
	HOST=$(host) BUILD=$(host) $(MAKE) -C ./depends V=1 NO_QT=1 
	./autogen.sh
	mkdir -p $(pkg_build_dir)
	./configure $(wallet_opts) 
	$(MAKE)
	cp src/zcashd $(pkg_build_dir)/zcashd-wallet
	cp src/zcash-cli $(pkg_build_dir)/zcash-cli-wallet
	cp zcutil/fetch-params.sh $(pkg_build_dir)/zcash-fetch-params-wallet.sh
	cp src/zcashd $(pkg_build_dir)/zcashd-node
	cp src/zcash-cli $(pkg_build_dir)/zcash-cli-node
	cp zcutil/fetch-params.sh $(pkg_build_dir)/zcash-fetch-params-node.sh

# prevent dh_prep from removing our build directory
override_dh_prep:
	dh_prep -X$(tmp_dir)

# autoconfigure step is to be skipped since we need 2 configurations
override_dh_auto_configure:

# skip auto test since we want to test each build separately
override_dh_auto_test:

# skip auto test since we want to test each build separately
override_dh_auto_install:
